#!/data/data/com.termux/files/usr/bin/bash
set -u

HOME="/data/data/com.termux/files/home"
REPO="$HOME/hpfa"
OUT="$HOME/hpfa/_out"
PACK="$HOME/HP_ARCHIVES/_PACKED"
BASE="$HOME/hpfa/_diag/engine_artifacts.CORE.BASELINE.json"
PY="$HOME/hpfa/.venv/bin/python"

FAIL=0
ok(){ echo "[OK] $*"; }
warn(){ echo "[WARN] $*"; }
fail(){ echo "[FAIL] $*"; FAIL=$((FAIL+1)); }
hr(){ echo "--------------------------------"; }

hr
echo "HPFA DOCTOR v2"
date -Is
hr

# repo
cd "$REPO" 2>/dev/null || { fail "repo missing"; exit 2; }
git rev-parse --is-inside-work-tree >/dev/null 2>&1 && ok "git repo" || fail "not git repo"

HEAD=$(git rev-parse HEAD 2>/dev/null)
REM=$(git rev-parse origin/main 2>/dev/null)

[ "$HEAD" = "$REM" ] && ok "HEAD sync remote" || warn "HEAD != remote"

# commands
command -v hpfa-run >/dev/null && ok "hpfa-run found" || fail "hpfa-run missing"
command -v hpfa-set-primary >/dev/null && ok "hpfa-set-primary found" || fail "hpfa-set-primary missing"

# primary dir
ENV="$HOME/.config/hpfa/primary.env"
if [ -f "$ENV" ]; then
 . "$ENV"
 [ -d "${PRIMARY_DIR:-}" ] && ok "PRIMARY_DIR=$PRIMARY_DIR" || fail "PRIMARY_DIR invalid"
else
 fail "primary.env missing"
fi

# python import SSOT
if [ -x "$PY" ]; then
 OUTP=$("$PY" - <<'PY'
import hpfa, hp_motor, sys
print(hpfa.__file__)
print(hp_motor.__file__)
PY
)
 echo "$OUTP"
 ok "python import"
else
 fail "venv python missing"
fi

# baseline fingerprint
FP=$(grep -Eo '"fingerprint_sha256":[ ]*"[^"]+"' "$BASE" 2>/dev/null | head -n1 | cut -d'"' -f4)
[ -n "$FP" ] && ok "baseline fp=$FP" || fail "baseline missing fp"

# guarded run smoke
TMP=$(mktemp)
hpfa-run >"$TMP" 2>&1 || true
tail -n 10 "$TMP"
grep -q RUN_GUARDED_COMPLETE "$TMP" && ok "engine run ok" || fail "engine run failed"
rm -f "$TMP"

# OUT stats
CNT=$(find "$OUT" -maxdepth 1 -name 'engine_run_*' 2>/dev/null | wc -l)
ok "runs=$CNT"

# PACK checksum
if [ -d "$PACK" ]; then
 cd "$PACK"
 BAD=$(sha256sum -c *.sha256 2>&1 | grep -v OK | wc -l)
 [ "$BAD" = 0 ] && ok "PACK sha256 valid" || fail "PACK checksum fail"
 cd "$REPO"
else
 warn "PACK dir missing"
fi

# github reachability
if command -v curl >/dev/null; then
 CODE=$(curl -s -o /dev/null -w "%{http_code}" https://github.com)
 [ "$CODE" = 200 ] && ok "github reachable" || warn "github http=$CODE"
else
 warn "curl missing"
fi

hr
if [ "$FAIL" = 0 ]; then
 ok "RESULT=PASS"
 exit 0
else
 fail "RESULT=FAIL count=$FAIL"
 exit 1
fi
