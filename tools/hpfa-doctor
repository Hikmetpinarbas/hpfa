#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

HOME="/data/data/com.termux/files/home"
REPO="$HOME/hpfa"
OUT="$REPO/_out"
PACK="$HOME/HP_ARCHIVES/_PACKED"
BASE="$REPO/_diag/engine_artifacts.CORE.BASELINE.json"
PY="$REPO/.venv/bin/python"
REMOTE_REF="${HPFA_DOCTOR_REMOTE_REF:-origin/main}"

# 1 => do smoke hpfa-run + validator, 0 => skip heavy steps (default 0 for batch stability)
DO_SMOKE="${HPFA_DOCTOR_SMOKE:-0}"

FAIL=0
ok(){ echo "[OK] $*"; }
warn(){ echo "[WARN] $*"; }
fail(){ echo "[FAIL] $*"; FAIL=$((FAIL+1)); }
hr(){ echo "--------------------------------"; }

hr
echo "HPFA DOCTOR v5.5"
date -Is
hr

cd "$REPO" 2>/dev/null || { fail "repo missing"; exit 2; }
git rev-parse --is-inside-work-tree >/dev/null 2>&1 && ok "git repo" || fail "not git repo"

HEAD="$(git rev-parse HEAD 2>/dev/null || true)"
REM="$(git rev-parse "$REMOTE_REF" 2>/dev/null || true)"
[ -n "$HEAD" ] && ok "HEAD=$HEAD" || fail "HEAD read fail"
[ -n "$REM" ] && ok "$REMOTE_REF=$REM" || warn "$REMOTE_REF read fail"
if [ -n "$HEAD" ] && [ -n "$REM" ] && [ "$HEAD" = "$REM" ]; then
  ok "HEAD sync remote_ref"
else
  warn "HEAD != remote_ref ($REMOTE_REF)"
fi

STRICT_GIT="${HPFA_DOCTOR_STRICT_GIT:-1}"

dirty="$(git status --porcelain || true)"
if [ -n "$dirty" ]; then
  if [ "$STRICT_GIT" = "1" ]; then
  fail "repo dirty (uncommitted/untracked changes present)"
else
  warn "repo dirty (non-fatal; HPFA_DOCTOR_STRICT_GIT=0)"
fi
  echo "[EVIDENCE] git status --porcelain:"
  echo "$dirty"
else
  ok "repo clean"
fi

command -v hpfa-run >/dev/null && ok "hpfa-run found" || fail "hpfa-run missing"
command -v hpfa-set-primary >/dev/null && ok "hpfa-set-primary found" || fail "hpfa-set-primary missing"

ENV="$HOME/.config/hpfa/primary.env"
if [ -f "$ENV" ]; then
  # shellcheck disable=SC1090
  . "$ENV"
  [ -d "${PRIMARY_DIR:-}" ] && ok "PRIMARY_DIR=$PRIMARY_DIR" || warn "PRIMARY_DIR invalid (non-fatal for doctor)"
else
  warn "primary.env missing (non-fatal for doctor)"
fi

if [ -x "$PY" ]; then
  OUTP="$("$PY" - <<'PY' 2>/dev/null || true
import hpfa, hp_motor
print(hpfa.__file__)
print(hp_motor.__file__)
PY
  )"
  [ -n "$OUTP" ] && { echo "$OUTP"; ok "python import"; } || fail "python import failed"
else
  fail "venv python missing"
fi

FP="$(grep -Eo '"fingerprint_sha256":[ ]*"[^"]+"' "$BASE" 2>/dev/null | head -n1 | cut -d'"' -f4 || true)"
[ -n "$FP" ] && ok "baseline fp=$FP" || fail "baseline missing fp"

# PACK checksum (cheap enough)
if [ -d "$PACK" ]; then
  sha_list="$(find "$PACK" -type f -name '*.sha256' -print 2>/dev/null | sort || true)"
  if [ -z "$sha_list" ]; then
    fail "PACK sha256 missing (no *.sha256 anywhere under $PACK)"
  else
    bad_lines=0; bad_files=0; total_files=0
    while IFS= read -r f; do
      [ -z "$f" ] && continue
      total_files=$((total_files + 1))
      out="$(sha256sum -c "$f" 2>&1 || true)"
      b="$(printf '%s\n' "$out" | awk '$0 !~ /OK$/ {c++} END{print c+0}')"
      if [ "$b" != "0" ]; then
        bad_files=$((bad_files + 1))
        bad_lines=$((bad_lines + b))
      fi
    done <<< "$sha_list"
    [ "$bad_lines" = "0" ] && ok "PACK sha256 valid (files=$total_files)" || fail "PACK checksum fail (bad_files=$bad_files bad_lines=$bad_lines)"
  fi
else
  warn "PACK dir missing"
fi

NORM="$REPO/tools/hpfa_doctor_history_normalize.sh"
[ -x "$NORM" ] && { "$NORM" >/dev/null 2>&1 || fail "doctor_history normalize failed"; ok "doctor_history normalized"; } || warn "doctor_history normalizer missing"

if [ "$DO_SMOKE" = "1" ]; then
  FIXTURE="$REPO/tools/_fixtures/doctor_match"
  if [ -f "$FIXTURE/events_canonical.csv" ] && [ -f "$FIXTURE/comparison_tidy.csv" ] && [ -f "$FIXTURE/xlsx_inventory.csv" ]; then
    ok "doctor fixture present"
    hpfa-set-primary "$FIXTURE" >/dev/null 2>&1 && ok "doctor fixture primary set" || fail "doctor fixture set-primary failed"

    TMP="$(mktemp)"
    set +e
    hpfa-run >"$TMP" 2>&1
    rc_run=$?
    set -e

    tail -n 18 "$TMP" || true
    grep -q RUN_GUARDED_COMPLETE "$TMP" && ok "engine run ok (fixture)" || fail "engine run failed (fixture)"
    run_dir="$(awk -F= '/OUT_DIR=/{print $2}' "$TMP" | tail -n1 | tr -d ' ' || true)"
    rm -f "$TMP"

    VAL="$REPO/tools/hpfa_validator_run_strict_core.sh"
    if [ -x "$VAL" ]; then
      if [ "${rc_run:-1}" = "0" ] && [ -n "${run_dir:-}" ] && [ -d "$run_dir" ]; then
        "$VAL" "$run_dir" >/dev/null 2>&1 || fail "strict-core validator failed"
        ok "validator evidence ok (_diag/validator_last.log)"
      else
        warn "validator skipped (rc_run=${rc_run:-NA} run_dir=${run_dir:-NA})"
      fi
    else
      warn "validator runner missing"
    fi
  else
    fail "doctor fixture missing (tools/_fixtures/doctor_match/*.csv)"
  fi
else
  warn "SMOKE skipped (HPFA_DOCTOR_SMOKE=0)"
fi

if command -v curl >/dev/null; then
  CODE="$(curl -s -o /dev/null -w "%{http_code}" https://github.com || true)"
  [ "$CODE" = 200 ] && ok "github reachable" || warn "github http=$CODE"
else
  warn "curl missing"
fi

hr
echo "[INFO] FAIL_COUNT=$FAIL"
if [ "$FAIL" = 0 ]; then
  ok "RESULT=PASS"
  exit 0
else
  echo "[FAIL] RESULT=FAIL count=$FAIL"
  exit 1
fi
